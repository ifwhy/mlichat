<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MliChat - Room {{ room_id }}</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '480px',
                    },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #00c853 0%, #00a152 50%, #007c3e 100%);
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .message-container {
            scrollbar-width: thin;
            scrollbar-color: #a5d6a7 transparent;
        }
        .message-container::-webkit-scrollbar {
            width: 6px;
        }
        .message-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .message-container::-webkit-scrollbar-thumb {
            background-color: #a5d6a7;
            border-radius: 3px;
        }
        .message-own {
            background: linear-gradient(135deg, #00c853 0%, #00a152 100%);
        }
        .message-other {
            background: #f1f5f9;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-animate {
            animation: fadeIn 0.3s ease-out;
        }
        .typing-indicator span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .header-glass {
            background: rgba(0, 161, 82, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex flex-col">
    <header class="header-glass border-b border-white/20 shadow-lg">
        <div class="max-w-4xl mx-auto px-3 sm:px-4 py-2 sm:py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                    <a href="/" class="text-white hover:text-white/80 transition flex-shrink-0">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </a>
                    <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                        <div class="min-w-0">
                            <h1 class="text-white font-semibold text-sm sm:text-base">Room MLIChat</h1>
                            <div class="flex items-center gap-1 sm:gap-2">
                                <code class="text-white text-xs sm:text-sm font-mono bg-white/20 px-1.5 sm:px-2 py-0.5 rounded truncate max-w-[100px] sm:max-w-none">{{ room_id }}</code>
                                <button id="copyRoomBtn" class="text-white/80 hover:text-white transition flex-shrink-0" title="Copy room code">
                                    <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4 flex-shrink-0">
                    <div class="hidden sm:flex items-center gap-2 text-white/90 text-sm bg-white/20 px-3 py-1 rounded-full">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span id="userNameDisplay" class="font-medium"></span>
                    </div>
                    <div class="flex items-center gap-1 sm:gap-2 text-white/90 text-xs sm:text-sm">
                        <div class="w-2 h-2 rounded-full bg-white animate-pulse"></div>
                        <span id="peerCount" class="hidden xs:inline">0 online</span>
                        <span id="peerCountMobile" class="xs:hidden">0</span>
                    </div>
                    <div class="hidden sm:flex items-center gap-2 text-white/90 text-sm bg-white/20 px-3 py-1 rounded-full">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        <span>Pesan Terenkripsi</span>
                    </div>
                    <div class="sm:hidden flex items-center justify-center w-8 h-8 bg-white/20 rounded-full">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-4xl w-full mx-auto flex flex-col p-2 sm:p-4">
        <div class="glass rounded-xl sm:rounded-2xl shadow-xl flex-1 flex flex-col overflow-hidden">
            <div id="messages" class="message-container flex-1 overflow-y-auto p-3 sm:p-4 space-y-2 sm:space-y-3">
            </div>

            <div id="typingIndicator" class="hidden px-3 sm:px-4 py-2 text-gray-500 text-xs sm:text-sm">
                <span id="typingText"></span>
                <span class="typing-indicator inline-flex gap-1 ml-1">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                </span>
            </div>

            <div class="p-2 sm:p-4 border-t border-gray-200 bg-gray-50">
                <div class="flex gap-2">
                    <input type="text" id="messageInput" placeholder="Ketik pesan Anda..." 
                        class="flex-1 border border-green-500 px-3 sm:px-4 py-2.5 sm:py-3 rounded-full bg-white  focus:outline-none focus:ring-2 ring-green-500 focus:border-transparent transition shadow-sm text-sm sm:text-base">
                    <button id="sendBtn" 
                        class="p-2.5 sm:px-6 sm:py-3 rounded-full message-own text-white font-semibold hover:opacity-90 transition transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed shadow-lg flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="peerList" class="mt-2 sm:mt-4 glass rounded-xl p-3 sm:p-4 hidden">
            <h3 class="text-gray-700 font-semibold mb-2 flex items-center gap-2 text-sm sm:text-base">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                Peserta
            </h3>
            <div id="peerListContent" class="flex flex-wrap gap-1.5 sm:gap-2">
            </div>
        </div>
    </main>

    <script>
        const roomId = "{{ room_id }}";
        const urlParams = new URLSearchParams(window.location.search);
        const displayName = decodeURIComponent(urlParams.get('name') || 'Anonymous');
        
        document.getElementById('userNameDisplay').textContent = displayName;
        
        let ws = null;
        let myPeerId = null;
        let encryptionKey = null;
        let typingTimeout = null;

        async function deriveKey(roomId) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(roomId + '-mlichat-secret'),
                'PBKDF2',
                false,
                ['deriveBits', 'deriveKey']
            );
            
            return await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: encoder.encode('mlichat-salt'),
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        }

        async function encryptMessage(message) {
            const encoder = new TextEncoder();
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                encryptionKey,
                encoder.encode(message)
            );
            
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);
            
            return btoa(String.fromCharCode(...combined));
        }

        async function decryptMessage(encryptedMessage) {
            try {
                const combined = Uint8Array.from(atob(encryptedMessage), c => c.charCodeAt(0));
                const iv = combined.slice(0, 12);
                const ciphertext = combined.slice(12);
                
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    encryptionKey,
                    ciphertext
                );
                
                return new TextDecoder().decode(decrypted);
            } catch (error) {
                console.error('Decryption failed:', error);
                return '[Decryption Failed]';
            }
        }

        function addMessage(content, senderName, senderId, timestamp, isSystem = false) {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message-animate';
            
            if (isSystem) {
                messageEl.innerHTML = `
                    <div class="text-center">
                        <span class="inline-block px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm">
                            ${content}
                        </span>
                    </div>
                `;
            } else {
                const isOwn = senderId === myPeerId;
                const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageEl.innerHTML = `
                    <div class="flex ${isOwn ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[85%] sm:max-w-[70%]">
                            ${!isOwn ? `<span class="text-xs text-gray-500 ml-2 mb-1 block">${senderName}</span>` : ''}
                            <div class="${isOwn ? 'message-own text-white' : 'message-other text-gray-800'} px-3 sm:px-4 py-2 rounded-2xl ${isOwn ? 'rounded-br-md' : 'rounded-bl-md'} shadow-sm">
                                <p class="break-words text-sm sm:text-base">${content}</p>
                            </div>
                            <span class="text-xs text-gray-400 ${isOwn ? 'text-right' : 'text-left'} block mt-1 ${isOwn ? 'mr-2' : 'ml-2'}">${time}</span>
                        </div>
                    </div>
                `;
            }
            
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updatePeerList(peers) {
            const peerCountEl = document.getElementById('peerCount');
            const peerCountMobileEl = document.getElementById('peerCountMobile');
            const peerListEl = document.getElementById('peerList');
            const peerListContentEl = document.getElementById('peerListContent');
            
            peerCountEl.textContent = `${peers.length} online`;
            peerCountMobileEl.textContent = peers.length;
            
            if (peers.length > 1) {
                peerListEl.classList.remove('hidden');
                peerListContentEl.innerHTML = peers.map(peer => `
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full ${peer.id === myPeerId ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'} text-sm">
                        <span class="w-2 h-2 rounded-full ${peer.id === myPeerId ? 'bg-green-500' : 'bg-green-400'}"></span>
                        ${peer.name}${peer.id === myPeerId ? ' (You)' : ''}
                    </span>
                `).join('');
            } else {
                peerListEl.classList.add('hidden');
            }
        }

        function showTyping(peerName, isTyping) {
            const typingEl = document.getElementById('typingIndicator');
            const typingTextEl = document.getElementById('typingText');
            
            if (isTyping) {
                typingTextEl.textContent = `${peerName} is typing`;
                typingEl.classList.remove('hidden');
            } else {
                typingEl.classList.add('hidden');
            }
        }

        async function connect() {
            encryptionKey = await deriveKey(roomId);
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${roomId}?name=${encodeURIComponent(displayName)}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('Connected to room:', roomId);
            };
            
            ws.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                
                switch (data.type) {
                    case 'connected':
                        myPeerId = data.peer_id;
                        addMessage(`Selamat datang di room ${roomId}`, '', '', '', true);
                        addMessage('Semua pesan terenkripsi end-to-end', '', '', '', true);
                        break;
                    
                    case 'message':
                        const decrypted = await decryptMessage(data.content);
                        addMessage(decrypted, data.sender_name, data.sender_id, data.timestamp);
                        break;
                    
                    case 'system':
                        addMessage(data.content, '', '', '', true);
                        break;
                    
                    case 'peer_list':
                        updatePeerList(data.peers);
                        break;
                    
                    case 'typing':
                        if (data.peer_id !== myPeerId) {
                            showTyping(data.peer_name, data.is_typing);
                        }
                        break;
                    
                    case 'pong':
                        break;
                }
            };
            
            ws.onclose = () => {
                addMessage('Disconnected from room. Reconnecting...', '', '', '', true);
                setTimeout(connect, 2000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                const encrypted = await encryptMessage(message);
                ws.send(JSON.stringify({
                    type: 'message',
                    content: encrypted
                }));
                input.value = '';
                sendTypingIndicator(false);
            }
        }

        function sendTypingIndicator(isTyping) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'typing',
                    is_typing: isTyping
                }));
            }
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('messageInput').addEventListener('input', () => {
            sendTypingIndicator(true);
            
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            typingTimeout = setTimeout(() => {
                sendTypingIndicator(false);
            }, 1000);
        });

        document.getElementById('sendBtn').addEventListener('click', sendMessage);

        document.getElementById('copyRoomBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(roomId).then(() => {
                const btn = document.getElementById('copyRoomBtn');
                btn.innerHTML = '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                setTimeout(() => {
                    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>';
                }, 2000);
            });
        });

        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);

        connect();
    </script>
</body>
</html>
